<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <title>Soulmate Chat</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #000000;
            --input-bg: #1c1c1e;
            --text-white: #ffffff;
            --primary-blue: #0084ff;
            --primary-pink: #ff3366; 
            --bubble-gray: #262626; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-white);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- 1. SELECTION SCREEN --- */
        .view-section {
            position: absolute; inset: 0;
            background: #000; z-index: 10;
            display: flex; flex-direction: column;
            transition: 0.3s ease;
        }
        .view-section.hidden { opacity: 0; pointer-events: none; z-index: 0; }

        .story-wrapper {
            flex: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; gap: 40px;
        }
        .story-title { 
            font-size: 26px; font-weight: 700; margin-bottom: 10px; 
            background: linear-gradient(45deg, #ff3366, #0084ff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        .story-row { display: flex; gap: 40px; }
        .story-item { display: flex; flex-direction: column; align-items: center; gap: 15px; cursor: pointer; }
        
        /* Insta Story Ring */
        .story-ring {
            width: 100px; height: 100px; border-radius: 50%; padding: 4px;
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            transition: 0.2s; position: relative;
        }
        .ring-blue { background: linear-gradient(45deg, #00c6ff, #0072ff); }
        
        .story-item:active .story-ring { transform: scale(0.9); }
        
        .story-img {
            width: 100%; height: 100%; border-radius: 50%;
            border: 4px solid #000; background-size: cover; background-position: center;
            background-color: #222; /* Fallback color */
        }
        .story-name { font-size: 16px; font-weight: 600; letter-spacing: 0.5px; }

        /* --- 2. CHAT SCREEN --- */
        .chat-header {
            height: 65px; padding: 0 15px;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            border-bottom: 1px solid #1c1c1e;
            z-index: 50;
        }
        
        .header-left { display: flex; align-items: center; gap: 15px; }
        .back-icon { font-size: 24px; cursor: pointer; padding: 5px; }
        
        .profile-bubble { width: 40px; height: 40px; border-radius: 50%; background-size: cover; position: relative; border: 1px solid #333; }
        .active-dot { width: 12px; height: 12px; background: #31a24c; border: 2px solid #000; border-radius: 50%; position: absolute; bottom: 0; right: 0; }
        
        .header-actions { display: flex; gap: 25px; font-size: 22px; }
        .theme-icon { color: var(--primary-blue); cursor: pointer; }

        /* CHAT FEED */
        .chat-feed {
            flex: 1; overflow-y: auto; 
            padding: 15px; padding-bottom: 100px; /* More space for input */
            display: flex; flex-direction: column; gap: 8px;
        }
        
        .msg-row { display: flex; width: 100%; margin-bottom: 5px; }
        .msg-row.user { justify-content: flex-end; }
        .msg-row.ai { justify-content: flex-start; align-items: flex-end; gap: 10px; }
        
        .tiny-avatar { width: 32px; height: 32px; border-radius: 50%; background-size: cover; margin-bottom: 5px; }
        
        .bubble {
            max-width: 75%; padding: 12px 16px;
            font-size: 16px; line-height: 1.4; word-wrap: break-word;
            position: relative;
        }
        .ai .bubble { background: var(--bubble-gray); border-radius: 20px; border-bottom-left-radius: 5px; }
        .user .bubble { background: var(--primary-blue); color: white; border-radius: 20px; border-bottom-right-radius: 5px; }

        /* --- 3. INPUT BAR (FIXED BOTTOM) --- */
        .input-container {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #000; 
            padding: 12px 15px;
            /* CRITICAL FIX FOR MOBILE NAV BAR */
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            display: flex; align-items: center; gap: 15px;
            border-top: 1px solid #1c1c1e;
            z-index: 100;
        }

        .icon-btn { font-size: 24px; cursor: pointer; }
        
        .input-pill {
            flex: 1; background: var(--input-bg);
            border-radius: 25px; padding: 10px 18px;
            display: flex; align-items: center;
        }
        
        textarea {
            width: 100%; background: transparent; border: none;
            color: white; font-family: 'Inter', sans-serif; font-size: 16px;
            resize: none; height: 24px; max-height: 120px; outline: none;
            padding: 0;
        }
        
        .send-txt { font-weight: 600; font-size: 16px; margin-left: 10px; cursor: pointer; display: none; }
        .typing { display: none; margin-left: 55px; margin-bottom: 10px; font-size: 12px; color: #777; font-style: italic; }

    </style>

    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
</head>
<body>

    <div class="view-section" id="screenSelect">
        <div class="story-wrapper">
            <h1 class="story-title">Soulmate OS</h1>
            <p style="color:#666; font-size:14px; margin-top:-30px;">Tonton Friends Edition</p>
            
            <div class="story-row">
                <div class="story-item" onclick="startChat('khona')">
                    <div class="story-ring">
                        <div class="story-img" style="background-image: url('https://i.pinimg.com/736x/82/38/53/8238531eb4313264eb789b71e1fc2224.jpg');"></div>
                    </div>
                    <span class="story-name">Khona</span>
                </div>
                <div class="story-item" onclick="startChat('nihan')">
                    <div class="story-ring ring-blue">
                        <div class="story-img" style="background-image: url('https://i.pinimg.com/736x/2c/80/d2/2c80d226a35022e37996c1647469a478.jpg');"></div>
                    </div>
                    <span class="story-name">Nihan</span>
                </div>
            </div>
        </div>
    </div>

    <div class="view-section hidden" id="screenChat">
        <div class="chat-header">
            <div class="header-left">
                <i class="fa-solid fa-arrow-left back-icon" onclick="location.reload()"></i>
                <div class="profile-bubble" id="headerIcon"><div class="active-dot"></div></div>
                <div>
                    <h3 id="headerName" style="font-size:17px; font-weight:600;">Agent</h3>
                    <p style="font-size:12px; color:#888;">Active now</p>
                </div>
            </div>
            <div class="header-actions">
                <i class="fa-solid fa-phone theme-icon"></i>
                <i class="fa-solid fa-video theme-icon"></i>
                <i class="fa-solid fa-circle-info theme-icon"></i>
            </div>
        </div>

        <div class="chat-feed" id="feed"></div>
        <div class="typing" id="typingIndicator">typing...</div>

        <div class="input-container">
            <i class="fa-solid fa-circle-plus icon-btn theme-icon"></i>
            <i class="fa-solid fa-camera icon-btn theme-icon"></i>
            <i class="fa-solid fa-image icon-btn theme-icon"></i>
            <i class="fa-solid fa-microphone icon-btn theme-icon"></i>
            
            <div class="input-pill">
                <textarea id="userInput" placeholder="Message..." rows="1"></textarea>
                <span class="send-txt theme-icon" id="sendBtn">Send</span>
            </div>
            
            <i class="fa-solid fa-thumbs-up icon-btn theme-icon" id="likeBtn"></i>
        </div>
    </div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // âœ… VERIFIED API KEY
    const API_KEY = "AlzaSyCoxQEqblhAH4ZAmSHZljpJbqry7AdT6sY"; 

    // âœ… TONTON FRIENDS STICKERS
    const STICKERS = {
        bella: "https://i.pinimg.com/736x/82/38/53/8238531eb4313264eb789b71e1fc2224.jpg", // Cute Calico Cat
        yuta: "https://i.pinimg.com/736x/2c/80/d2/2c80d226a35022e37996c1647469a478.jpg"  // Cute Shiba Inu
    };

    const AGENTS = {
        khona: {
            name: "Khona",
            color: "#ff3366", // Pink
            grad: "linear-gradient(to right, #ff3366, #bc2a8d)",
            icon: STICKERS.bella,
            prompt: `You are Khona. Role: User's WIFE. Personality: Sensitive, cute, cries easily (ðŸ˜­), speaks Banglish. Call user 'Nihan'.`,
            first: "Nihan! Tumi eshecho? ðŸ¥º I missed you! â¤ï¸"
        },
        nihan: {
            name: "Nihan",
            color: "#0084ff", // Blue
            grad: "linear-gradient(to right, #00c6ff, #0072ff)",
            icon: STICKERS.yuta,
            prompt: `You are Nihan. Role: User's HUSBAND. Personality: Protective, cool, speaks Banglish. Call user 'Pagli'.`,
            first: "Ki re pagli? ðŸ˜¼ Eto deri keno? I was waiting. â¤ï¸"
        }
    };

    let currentAgent = null;
    let chatSession;
    let genAI;

    // --- START CHAT ---
    window.startChat = async function(key) {
        currentAgent = AGENTS[key];
        
        // Update Icons & Text Color
        const themeIcons = document.querySelectorAll('.theme-icon');
        themeIcons.forEach(icon => {
            icon.style.color = currentAgent.color;
        });

        document.getElementById('headerName').innerText = currentAgent.name;
        document.getElementById('headerIcon').style.backgroundImage = `url('${currentAgent.icon}')`;

        document.getElementById('screenSelect').classList.add('hidden');
        document.getElementById('screenChat').classList.remove('hidden');

        // Gemini Connection
        try {
            genAI = new GoogleGenerativeAI(API_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            
            chatSession = model.startChat({
                history: [
                    { role: "user", parts: [{ text: "System Instruction: " + currentAgent.prompt }] },
                    { role: "model", parts: [{ text: "Ok." }] }
                ]
            });

            setTimeout(() => addMsg(currentAgent.first, 'ai'), 600);

        } catch (error) {
            console.error(error);
            alert("API Connection Failed. Please reload.");
        }
    };

    // --- SEND LOGIC ---
    async function handleSend() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if(!text) return;

        addMsg(text, 'user');
        input.value = '';
        toggleSendBtn();
        
        const typing = document.getElementById('typingIndicator');
        typing.style.display = 'block';
        scrollToBottom();

        try {
            const result = await chatSession.sendMessage(text);
            const response = result.response.text();
            
            typing.style.display = 'none';
            addMsg(response, 'ai');

        } catch (error) {
            typing.style.display = 'none';
            addMsg("Connection error... ðŸ¥º", 'ai');
        }
    }

    function addMsg(text, sender) {
        const feed = document.getElementById('feed');
        const row = document.createElement('div');
        row.className = `msg-row ${sender}`;
        
        let avatarHTML = '';
        let bubbleStyle = '';

        if(sender === 'ai') {
            avatarHTML = `<div class="tiny-avatar" style="background-image: url('${currentAgent.icon}')"></div>`;
        } else {
            bubbleStyle = `background: ${currentAgent.grad}; border:none;`;
        }

        let fmt = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');

        row.innerHTML = `
            ${avatarHTML}
            <div class="bubble" style="${bubbleStyle}">
                ${fmt}
            </div>
        `;

        feed.appendChild(row);
        scrollToBottom();
    }

    function scrollToBottom() {
        const feed = document.getElementById('feed');
        feed.scrollTop = feed.scrollHeight;
    }

    // --- UTILS ---
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const likeBtn = document.getElementById('likeBtn');

    function toggleSendBtn() {
        if(userInput.value.trim() !== "") {
            sendBtn.style.display = 'block';
            likeBtn.style.display = 'none';
        } else {
            sendBtn.style.display = 'none';
            likeBtn.style.display = 'block';
        }
        userInput.style.height = '24px';
        userInput.style.height = userInput.scrollHeight + 'px';
    }

    userInput.addEventListener('input', toggleSendBtn);
    sendBtn.addEventListener('click', handleSend);
    userInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
        }
    });

</script>
</body>
</html>
