<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <title>Soulmate Chat</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>

    <style>
        /* =========================================
           1. MESSENGER / INSTAGRAM THEME VARIABLES
           ========================================= */
        :root {
            /* Messenger/Insta Colors */
            --bg-color: #000000;
            --surface-color: #1c1c1d;
            --input-bg: #2c2c2e;
            --text-main: #ffffff;
            --text-sub: #8e8e93;
            
            /* Dynamic Gradients (Will change via JS) */
            --primary-grad: linear-gradient(to right, #ff3366, #bc2a8d); /* Insta Default */
            
            /* Dimensions */
            --radius-bubble: 22px;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background: var(--bg-color);
            color: var(--text-main);
            height: 100dvh;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        /* =========================================
           2. APP SHELL (Mobile UI)
           ========================================= */
        .app-frame {
            width: 100%; height: 100%;
            position: relative;
            background: var(--bg-color);
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        @media (min-width: 600px) {
            .app-frame {
                width: 400px; height: 95vh;
                margin-top: 2.5vh;
                border-radius: 35px;
                border: 1px solid #333;
                box-shadow: 0 0 50px rgba(0,0,0,0.5);
            }
        }

        /* =========================================
           3. SELECTION SCREEN (Story Style)
           ========================================= */
        .view {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            transition: 0.4s ease;
            background: var(--bg-color);
            z-index: 1; opacity: 0; pointer-events: none;
        }
        .view.active { opacity: 1; pointer-events: auto; z-index: 10; }

        .select-header { padding: 40px 20px; text-align: center; }
        .select-header h1 { font-size: 28px; font-weight: 700; background: linear-gradient(to right, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .story-container {
            display: flex; justify-content: center; gap: 30px; margin-top: 20px;
        }

        .story-circle {
            display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer;
        }
        
        .story-ring {
            width: 90px; height: 90px;
            border-radius: 50%; padding: 3px;
            /* Gradient Border like Insta Story */
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); 
            transition: 0.3s;
        }
        .story-ring.nihan-ring { background: linear-gradient(45deg, #00c6ff, #0072ff); }

        .story-img {
            width: 100%; height: 100%;
            border-radius: 50%; border: 4px solid #000;
            background-size: cover; background-position: center;
        }
        
        .story-circle:active .story-ring { transform: scale(0.95); }
        .story-name { font-size: 14px; font-weight: 600; letter-spacing: 0.5px; }

        /* =========================================
           4. CHAT INTERFACE (Messenger Style)
           ========================================= */
        .chat-header {
            padding: 10px 15px; height: 65px;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(20px);
            border-bottom: 1px solid #1c1c1d;
            z-index: 50;
        }

        .header-left { display: flex; align-items: center; gap: 12px; }
        .back-btn { font-size: 24px; color: var(--text-main); cursor: pointer; }
        
        .profile-pic { width: 40px; height: 40px; border-radius: 50%; background-size: cover; position: relative; }
        .active-badge { width: 12px; height: 12px; background: #31a24c; border: 2px solid #000; border-radius: 50%; position: absolute; bottom: 0; right: 0; }
        
        .header-info h3 { font-size: 16px; font-weight: 600; }
        .header-info p { font-size: 11px; color: var(--text-sub); }

        .header-icons { display: flex; gap: 20px; color: var(--primary); font-size: 20px; }
        .header-icons i { cursor: pointer; color: #0084ff; /* Messenger Blue Default */ }

        /* Chat Feed */
        .chat-feed {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 4px; /* Tight grouping like Messenger */
        }

        .msg-row { display: flex; width: 100%; margin-bottom: 10px; }
        .msg-row.user { justify-content: flex-end; }
        .msg-row.ai { justify-content: flex-start; align-items: flex-end; gap: 8px; }

        .avatar-tiny { width: 28px; height: 28px; border-radius: 50%; background-size: cover; margin-bottom: 5px; }

        .bubble {
            max-width: 75%; padding: 10px 16px;
            font-size: 15px; line-height: 1.4; word-wrap: break-word;
            position: relative;
        }

        /* AI Bubble (Gray) */
        .ai .bubble {
            background: #262626; /* Dark Gray */
            color: #fff;
            border-radius: 20px;
            border-bottom-left-radius: 5px;
        }

        /* User Bubble (Gradient) */
        .user .bubble {
            background: var(--primary-grad);
            color: white;
            border-radius: 20px;
            border-bottom-right-radius: 5px;
        }

        .thought-process {
            font-size: 10px; color: #bbb; display: block; margin-bottom: 4px; font-style: italic;
        }

        /* =========================================
           5. INPUT BAR (Pill Shape)
           ========================================= */
        .input-bar {
            padding: 10px 15px; background: #000;
            display: flex; align-items: center; gap: 12px;
        }
        
        .icon-btn { font-size: 20px; color: var(--primary); cursor: pointer; }

        .input-pill {
            flex: 1; background: var(--input-bg);
            border-radius: 20px; padding: 8px 15px;
            display: flex; align-items: center;
        }
        
        textarea {
            flex: 1; background: transparent; border: none;
            color: white; font-family: var(--font-main); font-size: 15px;
            resize: none; height: 20px; max-height: 80px; outline: none;
            padding: 0; margin-top: 2px;
        }

        .send-text { 
            font-weight: 600; font-size: 15px; 
            color: #0084ff; /* Dynamic */
            cursor: pointer; margin-left: 10px;
        }

        /* Loader */
        .loader { position: absolute; inset: 0; background: #000; z-index: 100; display: flex; align-items: center; justify-content: center; transition: 0.5s; }
        .meta-logo { font-size: 40px; background: linear-gradient(45deg, #00c6ff, #0072ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    </style>
    
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
</head>
<body>

<div class="app-frame">
    
    <div class="loader" id="sysLoader">
        <i class="fa-brands fa-meta meta-logo"></i>
    </div>

    <div class="view active" id="viewSelect">
        <div class="select-header">
            <h1>Chat With</h1>
            <p style="color:#666; font-size:13px; margin-top:5px;">Select your soulmate</p>
        </div>

        <div class="story-container">
            <div class="story-circle" onclick="System.boot('khona')">
                <div class="story-ring">
                    <div class="story-img" style="background-image: url('https://cdn-icons-png.flaticon.com/512/616/616430.png')"></div>
                </div>
                <span class="story-name">Khona</span>
            </div>

            <div class="story-circle" onclick="System.boot('nihan')">
                <div class="story-ring nihan-ring">
                    <div class="story-img" style="background-image: url('https://cdn-icons-png.flaticon.com/512/616/616554.png')"></div>
                </div>
                <span class="story-name">Nihan</span>
            </div>
        </div>
    </div>

    <div class="view" id="viewChat">
        <div class="chat-header">
            <div class="header-left">
                <i class="fa-solid fa-arrow-left back-btn" onclick="location.reload()"></i>
                <div class="profile-pic" id="headerIcon"><div class="active-badge"></div></div>
                <div class="header-info">
                    <h3 id="headerName">Agent</h3>
                    <p>Active now</p>
                </div>
            </div>
            <div class="header-icons">
                <i class="fa-solid fa-phone" id="callIcon"></i>
                <i class="fa-solid fa-video" id="videoIcon"></i>
                <i class="fa-solid fa-circle-info"></i>
            </div>
        </div>

        <div class="chat-feed" id="feed"></div>

        <div class="input-bar">
            <i class="fa-solid fa-circle-plus icon-btn" style="color:#0084ff" id="plusIcon"></i>
            <i class="fa-solid fa-camera icon-btn" style="color:#0084ff" id="camIcon"></i>
            <i class="fa-solid fa-image icon-btn" style="color:#0084ff" id="galleryIcon"></i>
            <i class="fa-solid fa-microphone icon-btn" onclick="Utils.voiceInput()" style="color:#0084ff" id="micIcon"></i>
            
            <div class="input-pill">
                <textarea id="userInput" placeholder="Message..." rows="1"></textarea>
                <span class="send-text" id="sendBtn" onclick="Chat.send()">Send</span>
            </div>
            
            <i class="fa-solid fa-thumbs-up icon-btn" style="color:#0084ff" id="likeIcon"></i>
        </div>
    </div>

</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // ðŸ”´ API KEY
    const API_KEY = "AlzaSyCoxQEqblhAH4ZAmSHZljpJbqry7AdT6sY"; 
    
    const DB = {
        agents: {
            khona: {
                name: "Khona",
                // Instagram Gradient
                grad: "linear-gradient(to right, #A855F7, #EC4899)", 
                uiColor: "#EC4899",
                icon: "https://cdn-icons-png.flaticon.com/512/616/616430.png",
                prompt: `Role: User's WIFE. Name: Khona. Personality: Emotional, cute, uses emojis (ðŸ˜­, â¤ï¸), speaks Banglish. Call user 'Nihan'.`,
                first: "Nihan! Tumi eshecho? ðŸ¥º I missed you! â¤ï¸"
            },
            nihan: {
                name: "Nihan",
                // Messenger Blue Gradient
                grad: "linear-gradient(to right, #00c6ff, #0072ff)", 
                uiColor: "#0084ff",
                icon: "https://cdn-icons-png.flaticon.com/512/616/616554.png",
                prompt: `Role: User's HUSBAND. Name: Nihan. Personality: Cool, protective, uses 'Pagli', 'Babu', speaks Banglish.`,
                first: "Ki re pagli? ðŸ˜¼ Eto deri keno? I was waiting. â¤ï¸"
            }
        }
    };

    let genAI, model, session;
    let currentAgent = null;

    window.System = {
        init: async () => {
            setTimeout(() => document.getElementById('sysLoader').style.opacity = '0', 1000);
            setTimeout(() => document.getElementById('sysLoader').style.display = 'none', 1500);
        },

        boot: async (agentKey) => {
            currentAgent = DB.agents[agentKey];
            
            // Set Theme Colors
            document.documentElement.style.setProperty('--primary-grad', currentAgent.grad);
            
            // Update Icons Colors to match theme
            const color = currentAgent.uiColor;
            ['callIcon','videoIcon','plusIcon','camIcon','galleryIcon','micIcon','likeIcon'].forEach(id => {
                document.getElementById(id).style.color = color;
            });
            document.getElementById('sendBtn').style.color = color;

            document.getElementById('headerName').innerText = currentAgent.name;
            document.getElementById('headerIcon').style.backgroundImage = `url('${currentAgent.icon}')`;

            // Transition
            document.getElementById('viewSelect').classList.remove('active');
            document.getElementById('viewChat').classList.add('active');

            try {
                genAI = new GoogleGenerativeAI(API_KEY);
                model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                session = model.startChat({
                    history: [
                        { role: "user", parts: [{ text: "System Instruction: " + currentAgent.prompt }] },
                        { role: "model", parts: [{ text: "System active." }] }
                    ]
                });
                setTimeout(() => Chat.addMsg(currentAgent.first, 'ai', "Seen just now"), 500);
            } catch (e) { console.error(e); }
        }
    };

    window.Chat = {
        send: async () => {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text) return;

            Chat.addMsg(text, 'user');
            input.value = '';
            Utils.autoResize(input);

            const typingId = Chat.showTyping();

            try {
                const result = await session.sendMessage(text);
                const response = result.response.text();
                Chat.removeTyping(typingId);
                
                let thought = "";
                if(text.includes('love')) thought = "typing...";
                
                Chat.addMsg(response, 'ai', thought);
            } catch (error) {
                Chat.removeTyping(typingId);
                Chat.addMsg("Connection error ðŸ¥º", 'ai');
            }
        },

        addMsg: (text, sender, thought = null) => {
            const feed = document.getElementById('feed');
            const row = document.createElement('div');
            row.className = `msg-row ${sender}`;
            
            let avatarHTML = '';
            if(sender === 'ai') {
                avatarHTML = `<div class="avatar-tiny" style="background-image: url('${currentAgent.icon}')"></div>`;
            }

            let fmt = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            let thoughtHTML = thought ? `<span class="thought-process">${thought}</span>` : '';

            row.innerHTML = `
                ${avatarHTML}
                <div class="bubble">
                    ${thoughtHTML}
                    ${fmt}
                </div>
            `;
            
            feed.appendChild(row);
            feed.scrollTop = feed.scrollHeight;
        },

        showTyping: () => {
            const feed = document.getElementById('feed');
            const id = 'typing-' + Date.now();
            const row = document.createElement('div');
            row.className = 'msg-row ai';
            row.id = id;
            row.innerHTML = `
                <div class="avatar-tiny" style="background-image: url('${currentAgent.icon}')"></div>
                <div class="bubble" style="color:#aaa; font-style:italic;">
                    <i class="fa-solid fa-ellipsis fa-fade"></i>
                </div>
            `;
            feed.appendChild(row);
            feed.scrollTop = feed.scrollHeight;
            return id;
        },

        removeTyping: (id) => { const el = document.getElementById(id); if(el) el.remove(); }
    };

    window.Utils = {
        voiceInput: () => {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'bn-BD';
            recognition.start();
            document.getElementById('micIcon').style.opacity = '0.5';
            recognition.onresult = (e) => {
                document.getElementById('userInput').value = e.results[0][0].transcript;
                document.getElementById('micIcon').style.opacity = '1';
                Utils.autoResize(document.getElementById('userInput'));
            };
        },
        autoResize: (el) => {
            el.style.height = '20px';
            el.style.height = el.scrollHeight + 'px';
        }
    };

    System.init();
    
    // Listeners
    document.getElementById('userInput').addEventListener('input', function() { 
        Utils.autoResize(this);
        // Toggle Like button to Send button logic
        const btn = document.getElementById('sendBtn');
        const like = document.getElementById('likeIcon');
        if(this.value.trim() !== "") {
            btn.style.display = "block"; like.style.display = "none";
        } else {
            btn.style.display = "none"; like.style.display = "block";
        }
    });

    // Default state: Hide Send text, show Like icon
    document.getElementById('sendBtn').style.display = "none";

</script>
</body>
</html>
